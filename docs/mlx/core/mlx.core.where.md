Curator's note: Prefer the human-authored MLX guides for clarity. - ../docs\\\\\\\_curated/README.md - ../docs\\\\\\\_curated/PYTORCH\\\\\\\_DISSONANCE.md - ../docs\\\\\\\_curated/NUMPY\\\\\\\_USERS.md - ../docs\\\\\\\_curated/COMMON\\\\\\\_PITFALLS.md \\\[\\\](https://github.com/ml-explore/mlx "Source repository")\\\\- \\\[.rst\\\](https://ml-explore.github.io/mlx/build/html/\\\_sources/python/\\\_autosummary/mlx.core.where.rst "Download source file") - .pdf # mlx.core.where ## Contents \\\\- \\\[\\\`\\\`where()\\\`\\\`\\\](https://ml-explore.github.io/mlx/build/html/#mlx.core.where) # mlx.core.where ## Curated Notes - Elementwise conditional: returns a new array selecting between \\\\\\\`x\\\\\\\` and \\\\\\\`y\\\\\\\` using \\\\\\\`condition\\\\\\\` with full NumPy‑style broadcasting rules. - Lazy + fuseable: \\\\\\\`mx.where\\\\\\\` participates in the lazy graph; evaluation is deferred until needed and may be fused with adjacent ops. - No \\\\\\\`device=\\\\\\\`: control placement via default device or per‑op \\\\\\\`stream\\\\\\\`. - Grad‑friendly: works under \\\\\\\`mx.value\\\\\\\_and\\\\\\\_grad\\\\\\\`; condition is treated as data, not control flow. ### Performance Implications - Vectorized execution: runs in parallel over all elements (CPU/GPU), far faster than Python \\\\\\\`for\\\\\\\` loops with \\\\\\\`if/else\\\\\\\`. - Lazy evaluation: builds a graph node; MLX can fuse producers/consumers of \\\\\\\`where\\\\\\\` to reduce memory traffic. - Branchless on GPU: typically computes both \\\\\\\`x\\\\\\\` and \\\\\\\`y\\\\\\\` expressions and then selects. This avoids warp divergence and is standard for SIMD/SIMT hardware. - Allocation: produces a new array. MLX may reuse buffers due to laziness, but treat it as an allocation in your mental model. When to prefer \\\\\\\`mx.where\\\\\\\`: - Large arrays and batched math where parallelism dominates. - Inside larger MLX graphs (especially compiled) where kernels can be fused. - Differentiable conditionals where you need gradients to flow through \\\\\\\`x\\\\\\\`/\\\\\\\`y\\\\\\\`. Python loop vs \\\\\\\`mx.where\\\\\\\` (summary): - Execution: vectorized, hardware‑accelerated vs interpreted, single‑threaded. - Computation: typically evaluates both \\\\\\\`x\\\\\\\` and \\\\\\\`y\\\\\\\` vs per‑element branch; the former wins on GPUs by avoiding divergence and leveraging throughput. - Graph: \\\\\\\`mx.where\\\\\\\` is part of the MLX graph (optimizable, differentiable); loops are not. Tips: - Keep \\\\\\\`x\\\\\\\`/\\\\\\\`y\\\\\\\` expressions as simple as possible; heavy, redundant work will be computed for all elements. - For chained conditionals, compose \\\\\\\`where\\\\\\\` calls or precompute masks; MLX can still fuse simple patterns. - Wrap \\\\\\\`where\\\\\\\` usage inside a compiled function (if available) to maximize fusion and scheduling. ### Examples \\\\\\\`\\\\\\\`\\\\\\\`python import mlx.core as mx x = mx.arange(10) mask = (x % 2) == 0 y = mx.where(mask, x, -x) # even keep, odd negate # Conditional arithmetic z = mx.where(x > 3, x \\\\\\\* 10, x + 1) # Under grad def loss(a): return mx.mean(mx.where(a > 0, a, 0.1 \\\\\\\* a) \\\\\\\*\\\\\\\* 2) val, grad = mx.value\\\\\\\_and\\\\\\\_grad(loss)(x.astype(mx.float32)) # Route to CPU if you need float64 internally with mx.default\\\\\\\_device(mx.cpu): y64 = mx.where(mask, x.astype(mx.float64), (-x).astype(mx.float64)) \\\\\\\`\\\\\\\`\\\\\\\` \\\`where\\\`(\\\\\\\*\\\`condition\\\`\\\`:\\\` \\\`scalar\\\` \\\`\\\\\\\\|\\\` \\\[\\\`array\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")\\\\\\\*, \\\\\\\*\\\`x\\\`\\\`:\\\` \\\`scalar\\\` \\\`\\\\\\\\|\\\` \\\[\\\`array\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")\\\\\\\*, \\\\\\\*\\\`y\\\`\\\`:\\\` \\\`scalar\\\` \\\`\\\\\\\\|\\\` \\\[\\\`array\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")\\\\\\\*, \\\\\\\*\\\`/\\\`\\\\\\\*, \\\\\\\*\\\`\\\\\\\\\\\\\\\*\\\`\\\\\\\*, \\\\\\\*\\\`stream\\\`\\\`:\\\` \\\[\\\`None\\\`\\\](https://docs.python.org/3/library/constants.html#None "(in Python v3.13)") \\\`\\\\\\\\|\\\` \\\[\\\`Stream\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/stream\\\_class.html#mlx.core.Stream "mlx.core.Stream") \\\`\\\\\\\\|\\\` \\\[\\\`Device\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.Device.html#mlx.core.Device "mlx.core.Device") \\\`\\\\=\\\` \\\`None\\\`\\\\\\\*) → \\\[\\\`array\\\`\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array") Select from \\\`\\\\\\\`x\\\\\\\`\\\` or \\\`\\\\\\\`y\\\\\\\`\\\` according to \\\`\\\\\\\`condition\\\\\\\`\\\`. The condition and input arrays must be the same shape or broadcastable with each another. Parameters: - \\\\\\\*\\\\\\\*condition\\\\\\\*\\\\\\\* (\\\[\\\*array\\\*\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")) – The condition array. - \\\\\\\*\\\\\\\*x\\\\\\\*\\\\\\\* (\\\[\\\*array\\\*\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")) – The input selected from where condition is \\\`\\\\\\\`True\\\\\\\`\\\`. - \\\\\\\*\\\\\\\*y\\\\\\\*\\\\\\\* (\\\[\\\*array\\\*\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array")) – The input selected from where condition is \\\`\\\\\\\`False\\\\\\\`\\\`. Returns: The output containing elements selected from \\\`\\\\\\\`x\\\\\\\`\\\` and \\\`\\\\\\\`y\\\\\\\`\\\`. Return type: \\\[\\\*array\\\*\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.array.html#mlx.core.array "mlx.core.array") \\\[\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.view.html "previous page") previous mlx.core.view \\\[\\\](https://ml-explore.github.io/mlx/build/html/python/\\\_autosummary/mlx.core.zeros.html "next page") next mlx.core.zeros Contents \\\\- \\\[\\\`\\\`where()\\\`\\\`\\\](https://ml-explore.github.io/mlx/build/html/#mlx.core.where) By MLX Contributors © Copyright 2023, MLX Contributors.
